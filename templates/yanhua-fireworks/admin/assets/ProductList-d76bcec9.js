import{b as me,r as c,c as ve,k as fe,x as ge,e as u,y as _e,o as f,f as I,h as a,w as r,g,i as p,z as ye,p as E,t as C,F as be,m as Ve,q as we,u as Ue,E as n,A as he,B as Ce}from"./index-1dad1f50.js";import{g as ke,a as xe,b as Le,d as Re,u as Ie,c as Ee}from"./product-1c9747b1.js";import{g as Pe}from"./product-video-e78a6195.js";import{s as j}from"./request-0b13b1fd.js";import{_ as ze}from"./_plugin-vue_export-helper-c27b6911.js";const Be={class:"page-container"},De={class:"card-header"},Se={key:1,style:{color:"#909399"}},Te={class:"pagination"},Me={style:{color:"#8492a6","font-size":"12px","margin-left":"8px"}},Oe={style:{width:"100%"}},qe={key:1,class:"upload-loading"},Fe=me({__name:"ProductList",setup($e){const A=Ue(),P=c(!1),k=c([]),D=c([]),z=c([]),S=c(0),x=c(1),T=c(10),w=c({}),_=c(!1),B=c("新增产品"),M=c(),s=ve({id:void 0,name:"",code:"",categoryId:void 0,content:"",volume:"",image:"",videoUrl:"",status:1}),L=c(!1),y=c([]),G=o=>{if(!["video/mp4","video/quicktime","video/x-msvideo","video/x-ms-wmv","video/x-flv"].includes(o.type))return n.error("只支持视频格式(mp4、mov、avi、wmv、flv)"),!1;const l=100;return o.size/1024/1024<l?!0:(n.error(`视频大小不能超过 ${l}MB`),!1)},H=async o=>new Promise((e,d)=>{const l=document.createElement("video"),i=document.createElement("canvas"),U=i.getContext("2d");l.preload="metadata",l.muted=!0,l.playsInline=!0,l.crossOrigin="anonymous",l.onloadedmetadata=()=>{i.width=l.videoWidth,i.height=l.videoHeight,l.currentTime=.1},l.onseeked=async()=>{try{U==null||U.drawImage(l,0,0,i.width,i.height),i.toBlob(async m=>{if(!m){d(new Error("无法截取视频封面"));return}try{const b=new FormData;b.append("file",m,"cover.jpg");const h=await j.post("/upload/image",b,{headers:{"Content-Type":"multipart/form-data"}});h.data.code===200?e(h.data.data.url):d(new Error(h.data.message||"封面上传失败"))}catch(b){d(b)}finally{URL.revokeObjectURL(l.src),l.src=""}},"image/jpeg",.9)}catch(m){URL.revokeObjectURL(l.src),d(m)}},l.onerror=m=>{URL.revokeObjectURL(l.src),console.error("视频加载错误:",m),d(new Error("视频加载失败，请确保视频文件格式正确"))};try{l.src=URL.createObjectURL(o)}catch{d(new Error("无法创建视频URL"))}}),W=async o=>{L.value=!0;try{const e=o.file,d=new FormData;d.append("file",e);const l=await j.post("/upload/video",d,{headers:{"Content-Type":"multipart/form-data"}});if(l.data.code===200){s.videoUrl=l.data.data.url,y.value=[{name:l.data.data.filename,url:l.data.data.url}],n.success("视频上传成功");try{n.info("正在生成封面...");const i=await H(e);s.image=i,n.success("封面生成成功")}catch(i){console.error("封面生成失败",i),n.warning("封面生成失败，请手动设置图片URL")}o.onSuccess(l.data)}else{n.error(l.data.message||"上传失败");const i=new Error(l.data.message);i.status=l.status,i.method="POST",i.url="/upload/video",o.onError(i)}}catch(e){console.error("视频上传失败",e),n.error(e.message||"上传失败"),o.onError(e)}finally{L.value=!1}},J=()=>{s.videoUrl="",y.value=[]},O=()=>{s.videoUrl?y.value=[{name:"当前视频",url:s.videoUrl}]:y.value=[]},K=fe(()=>{const o=[];return D.value.forEach(e=>{o.push(e),e.children&&e.children.length>0&&o.push(...e.children)}),o}),R=async()=>{P.value=!0;try{const o=await ke({page:x.value,pageSize:T.value});o.data.code===200?(k.value=o.data.data.records,S.value=o.data.data.total,await Q()):n.error(o.data.message||"获取产品列表失败")}catch(o){console.error("加载产品列表失败",o),n.error(o.message||"获取产品列表失败")}finally{P.value=!1}},Q=async()=>{if(k.value.length===0){w.value={};return}try{const o=k.value.map(d=>d.id),e=await Pe(o);e.data.code===200?w.value=e.data.data||{}:(console.error("获取产品视频数量失败",e.data.message),w.value={})}catch(o){console.error("加载产品视频数量失败",o),w.value={}}},q=o=>w.value[o]||0,X=o=>{A.push(`/product/videos/${o}`)},Y=async()=>{try{const o=await xe();o.data.code===200?D.value=o.data.data:n.error(o.data.message||"获取分类列表失败")}catch(o){console.error("加载分类失败",o),n.error(o.message||"获取分类列表失败")}},Z=async()=>{try{const o=await Le();o.data.code===200?z.value=o.data.data:n.error(o.data.message||"获取子分类列表失败")}catch(o){console.error("加载子分类失败",o),n.error(o.message||"获取子分类列表失败")}},F=o=>{const e=K.value.find(d=>d.id===o);return e?e.name:"-"},ee=()=>{B.value="新增产品",Object.assign(s,{id:void 0,name:"",code:"",categoryId:void 0,content:"",volume:"",image:"",videoUrl:"",status:1}),O(),_.value=!0},oe=o=>{B.value="编辑产品",Object.assign(s,o),O(),_.value=!0},te=async o=>{try{await he.confirm("确定删除该产品吗？","提示",{type:"warning"});const e=await Re(o.id);e.data.code===200?(n.success("删除成功"),R()):n.error(e.data.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败",e),n.error(e.message||"删除失败"))}},ae=async()=>{if(M.value){if(s.categoryId){const o=z.value.find(e=>e.id===s.categoryId);if(!o){n.error("请选择有效的子分类");return}if(!o.parentId||o.parentId===0){n.error("产品只能关联到子分类，不能关联到父分类");return}}try{let o;s.id?o=await Ie(s):o=await Ee(s),o.data.code===200?(n.success(s.id?"更新成功":"添加成功"),_.value=!1,R()):n.error(o.data.message||"操作失败")}catch(o){console.error("保存失败",o),n.error(o.message||"操作失败")}}},le=o=>{x.value=o,R()};return ge(()=>{Y(),Z(),R()}),(o,e)=>{const d=u("el-button"),l=u("el-table-column"),i=u("el-link"),U=u("el-tag"),m=u("el-table"),b=u("el-pagination"),h=u("el-card"),V=u("el-input"),v=u("el-form-item"),re=u("el-option"),se=u("el-select"),ne=u("el-icon"),de=u("el-upload"),$=u("el-radio"),ie=u("el-radio-group"),ue=u("el-form"),ce=u("el-dialog"),pe=_e("loading");return f(),I("div",Be,[a(h,{shadow:"never"},{header:r(()=>[g("div",De,[e[13]||(e[13]=g("span",null,"产品列表",-1)),a(d,{type:"primary",onClick:ee},{default:r(()=>[...e[12]||(e[12]=[p("新增产品",-1)])]),_:1})])]),default:r(()=>[ye((f(),E(m,{data:k.value,stripe:""},{default:r(()=>[a(l,{prop:"id",label:"ID",width:"80"}),a(l,{prop:"name",label:"产品名称"}),a(l,{prop:"code",label:"编号"}),a(l,{label:"分类"},{default:r(({row:t})=>[p(C(F(t.categoryId)),1)]),_:1}),a(l,{prop:"content",label:"含量"}),a(l,{label:"产品视频",width:"100",align:"center"},{default:r(({row:t})=>[q(t.id)>0?(f(),E(i,{key:0,type:"primary",onClick:N=>X(t.id)},{default:r(()=>[p(C(q(t.id))+" 个 ",1)]),_:2},1032,["onClick"])):(f(),I("span",Se,"0"))]),_:1}),a(l,{prop:"views",label:"浏览量",width:"100"}),a(l,{prop:"likes",label:"点赞数",width:"100"}),a(l,{prop:"status",label:"状态",width:"100"},{default:r(({row:t})=>[a(U,{type:t.status===1?"success":"info"},{default:r(()=>[p(C(t.status===1?"上架":"下架"),1)]),_:2},1032,["type"])]),_:1}),a(l,{label:"操作",width:"180",fixed:"right"},{default:r(({row:t})=>[a(d,{type:"primary",link:"",onClick:N=>oe(t)},{default:r(()=>[...e[14]||(e[14]=[p("编辑",-1)])]),_:1},8,["onClick"]),a(d,{type:"danger",link:"",onClick:N=>te(t)},{default:r(()=>[...e[15]||(e[15]=[p("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[pe,P.value]]),g("div",Te,[a(b,{"current-page":x.value,"onUpdate:currentPage":e[0]||(e[0]=t=>x.value=t),"page-size":T.value,total:S.value,layout:"total, prev, pager, next",onCurrentChange:le},null,8,["current-page","page-size","total"])])]),_:1}),a(ce,{modelValue:_.value,"onUpdate:modelValue":e[11]||(e[11]=t=>_.value=t),title:B.value,width:"600px"},{footer:r(()=>[a(d,{onClick:e[10]||(e[10]=t=>_.value=!1)},{default:r(()=>[...e[20]||(e[20]=[p("取消",-1)])]),_:1}),a(d,{type:"primary",onClick:ae},{default:r(()=>[...e[21]||(e[21]=[p("保存",-1)])]),_:1})]),default:r(()=>[a(ue,{ref_key:"formRef",ref:M,model:s,"label-width":"100px"},{default:r(()=>[a(v,{label:"产品名称",prop:"name",required:""},{default:r(()=>[a(V,{modelValue:s.name,"onUpdate:modelValue":e[1]||(e[1]=t=>s.name=t),placeholder:"请输入产品名称"},null,8,["modelValue"])]),_:1}),a(v,{label:"产品编号",prop:"code",required:""},{default:r(()=>[a(V,{modelValue:s.code,"onUpdate:modelValue":e[2]||(e[2]=t=>s.code=t),placeholder:"请输入产品编号"},null,8,["modelValue"])]),_:1}),a(v,{label:"分类",prop:"categoryId",required:""},{default:r(()=>[a(se,{modelValue:s.categoryId,"onUpdate:modelValue":e[3]||(e[3]=t=>s.categoryId=t),placeholder:"请选择分类（仅显示子分类）",style:{width:"100%"}},{default:r(()=>[(f(!0),I(be,null,Ve(z.value,t=>(f(),E(re,{key:t.id,label:t.name,value:t.id},{default:r(()=>[g("span",null,C(t.name),1),g("span",Me," ("+C(F(t.parentId||0))+") ",1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),e[16]||(e[16]=g("div",{style:{color:"#909399","font-size":"12px","margin-top":"4px"}}," 注意：产品只能关联到子分类，不能关联到父分类 ",-1))]),_:1}),a(v,{label:"含量",prop:"content"},{default:r(()=>[a(V,{modelValue:s.content,"onUpdate:modelValue":e[4]||(e[4]=t=>s.content=t),placeholder:"如：6/50/35"},null,8,["modelValue"])]),_:1}),a(v,{label:"体积",prop:"volume"},{default:r(()=>[a(V,{modelValue:s.volume,"onUpdate:modelValue":e[5]||(e[5]=t=>s.volume=t),placeholder:"如：41*24.5*24.3"},null,8,["modelValue"])]),_:1}),a(v,{label:"图片URL",prop:"image"},{default:r(()=>[a(V,{modelValue:s.image,"onUpdate:modelValue":e[6]||(e[6]=t=>s.image=t),placeholder:"请输入图片URL"},null,8,["modelValue"])]),_:1}),a(v,{label:"视频URL",prop:"videoUrl"},{default:r(()=>[g("div",Oe,[a(de,{"file-list":y.value,"onUpdate:fileList":e[7]||(e[7]=t=>y.value=t),"http-request":W,"before-upload":G,"on-remove":J,limit:1,"list-type":"picture-card",disabled:L.value},{default:r(()=>[L.value?(f(),I("div",qe,"上传中...")):(f(),E(ne,{key:0},{default:r(()=>[a(we(Ce))]),_:1}))]),_:1},8,["file-list","disabled"]),e[17]||(e[17]=g("div",{style:{color:"#909399","font-size":"12px","margin-top":"4px"}}," 支持视频格式(mp4、mov、avi、wmv、flv)，大小不超过100MB，上传后自动生成封面 ",-1)),a(V,{modelValue:s.videoUrl,"onUpdate:modelValue":e[8]||(e[8]=t=>s.videoUrl=t),placeholder:"或直接输入视频URL",style:{"margin-top":"8px"}},null,8,["modelValue"])])]),_:1}),a(v,{label:"状态",prop:"status"},{default:r(()=>[a(ie,{modelValue:s.status,"onUpdate:modelValue":e[9]||(e[9]=t=>s.status=t)},{default:r(()=>[a($,{label:1},{default:r(()=>[...e[18]||(e[18]=[p("上架",-1)])]),_:1}),a($,{label:0},{default:r(()=>[...e[19]||(e[19]=[p("下架",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}});const We=ze(Fe,[["__scopeId","data-v-4564d3bb"]]);export{We as default};
