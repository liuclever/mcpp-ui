# 产品详情页评论输入功能集成说明

## 修改时间
2026-01-02

## 问题描述

用户反馈产品详情页的评论功能存在以下问题：
1. ❌ **没有"发表评论"的入口** - 用户无法发表新评论
2. ❌ **点击回复只显示文字提示** - 点击"回复"按钮只弹出 Toast 提示"回复张三"，没有输入框

## 解决方案

已完成以下修改，添加完整的评论和回复功能：

### 1. 引入 comment-input 组件

**文件：`detail.json`**

```json
{
  "usingComponents": {
    "nav-bar": "/components/nav-bar/nav-bar",
    "comment-list": "/components/comment-list/comment-list",
    "comment-input": "/components/comment-input/comment-input"  // ✅ 新增
  },
  "navigationStyle": "custom"
}
```

### 2. 添加评论输入界面

**文件：`detail.wxml`**

#### 2.1 在评论弹窗底部添加"发表评论"按钮

```xml
<!-- 评论弹窗 -->
<view class="comment-modal" wx:if="{{showCommentModal}}" bindtap="hideCommentModal">
  <view class="comment-container" catchtap="">
    <view class="comment-header">
      <text class="comment-title">评论</text>
      <image src="/assets/icons/close.png" class="comment-close-btn" bindtap="hideCommentModal"></image>
    </view>
    <view class="comment-content">
      <comment-list ... />
    </view>
    <!-- ✅ 新增：发表评论按钮 -->
    <view class="comment-footer">
      <button class="comment-input-btn" bindtap="showCommentInput">发表评论...</button>
    </view>
  </view>
</view>
```

#### 2.2 添加两个 comment-input 组件

```xml
<!-- ✅ 新增：发表评论输入框 -->
<comment-input
  id="commentInput"
  videoId="{{productId}}"
  show="{{showCommentInput}}"
  autoFocus="{{true}}"
  bind:submit="onCommentSubmit"
  bind:cancel="onCommentCancel"
/>

<!-- ✅ 新增：回复评论输入框 -->
<comment-input
  id="replyInput"
  videoId="{{productId}}"
  parentId="{{replyComment.id}}"
  replyToId="{{replyComment.userId}}"
  replyToName="{{replyComment.userName}}"
  show="{{showReplyInput}}"
  autoFocus="{{true}}"
  bind:submit="onReplySubmit"
  bind:cancel="onReplyCancel"
/>
```

### 3. 添加页面逻辑

**文件：`detail.ts`**

#### 3.1 添加数据字段

```typescript
data: {
  // ... 原有字段
  showCommentInput: false,   // ✅ 新增：是否显示评论输入框
  showReplyInput: false,     // ✅ 新增：是否显示回复输入框
  replyComment: null         // ✅ 新增：要回复的评论对象
}
```

#### 3.2 修改回复评论方法

```typescript
// ✅ 修改：显示回复输入框
onReplyComment(e: any) {
  const { comment } = e.detail
  console.log('回复评论:', comment)
  
  // 显示回复输入框
  this.setData({
    showReplyInput: true,
    replyComment: comment
  })
}
```

#### 3.3 添加评论相关方法

```typescript
// ✅ 新增：显示评论输入框
showCommentInput() {
  this.setData({
    showCommentInput: true
  })
}

// ✅ 新增：提交评论
onCommentSubmit(e: any) {
  const { videoId, content } = e.detail
  console.log('提交评论:', { videoId, content })
  
  // TODO: 调用API提交评论
  setTimeout(() => {
    wx.showToast({ title: '评论成功', icon: 'success' })
    
    // 重置输入框
    const commentInput = this.selectComponent('#commentInput') as any
    if (commentInput) {
      commentInput.reset()
    }
    
    // 隐藏输入框
    this.setData({ showCommentInput: false })
    
    // 刷新评论列表
    this.loadComments()
  }, 500)
}

// ✅ 新增：取消评论
onCommentCancel() {
  this.setData({ showCommentInput: false })
}

// ✅ 新增：提交回复
onReplySubmit(e: any) {
  const { videoId, content, parentId, replyToId } = e.detail
  console.log('提交回复:', { videoId, content, parentId, replyToId })
  
  // TODO: 调用API提交回复
  setTimeout(() => {
    wx.showToast({ title: '回复成功', icon: 'success' })
    
    // 重置输入框
    const replyInput = this.selectComponent('#replyInput') as any
    if (replyInput) {
      replyInput.reset()
    }
    
    // 隐藏输入框
    this.setData({
      showReplyInput: false,
      replyComment: null
    })
    
    // 刷新评论列表
    this.loadComments()
  }, 500)
}

// ✅ 新增：取消回复
onReplyCancel() {
  this.setData({
    showReplyInput: false,
    replyComment: null
  })
}
```

### 4. 添加样式

**文件：`detail.wxss`**

```css
/* ✅ 新增：评论底部按钮 */
.comment-footer {
  padding: 20rpx 30rpx;
  padding-bottom: calc(20rpx + env(safe-area-inset-bottom));
  border-top: 1rpx solid #f0f0f0;
  background: #fff;
  flex-shrink: 0;
}

.comment-input-btn {
  width: 100%;
  height: 80rpx;
  background: #f5f5f5;
  border-radius: 40rpx;
  border: none;
  color: #999;
  font-size: 28rpx;
  text-align: left;
  padding-left: 30rpx;
  line-height: 80rpx;
}

.comment-input-btn::after {
  border: none;
}
```

## 功能说明

### 📝 发表评论流程

1. 用户点击底部评论图标 → 打开评论弹窗
2. 用户点击"发表评论..."按钮 → 弹出评论输入框
3. 用户输入评论内容（最多200字）
4. 用户点击"发送"按钮 → 提交评论
5. 提交成功 → 清空输入框 → 关闭输入框 → 刷新评论列表

### 💬 回复评论流程

1. 用户点击某条评论的"回复"按钮 → 弹出回复输入框
2. 输入框显示"回复 @用户名"
3. 用户输入回复内容
4. 用户点击"发送"按钮 → 提交回复（包含 parentId 和 replyToId）
5. 提交成功 → 清空输入框 → 关闭输入框 → 刷新评论列表

## 界面效果

### 评论弹窗
```
┌─────────────────────┐
│ 评论            [×] │
├─────────────────────┤
│                     │
│   评论列表...        │
│                     │
├─────────────────────┤
│ [发表评论...]        │  ← 新增的按钮
└─────────────────────┘
```

### 发表评论输入框
```
┌─────────────────────┐
│                     │
│  [输入框]            │
│  发表评论...         │
│                     │
│  0/200              │
│                     │
│  [取消]  [发送]      │
└─────────────────────┘
```

### 回复评论输入框
```
┌─────────────────────┐
│ 回复 @张三      [×]  │  ← 显示回复目标
├─────────────────────┤
│  [输入框]            │
│  回复 @张三          │
│                     │
│  0/200              │
│                     │
│  [取消]  [发送]      │
└─────────────────────┘
```

## 待完成事项

目前使用的是模拟数据和延时操作，需要后续集成真实的API：

### 1. 提交评论API

```typescript
onCommentSubmit(e: any) {
  const { videoId, content } = e.detail
  
  // TODO: 替换为真实API调用
  wx.request({
    url: 'https://your-api.com/api/interaction/comment',
    method: 'POST',
    data: {
      videoId: videoId,
      content: content
    },
    header: {
      'Authorization': 'Bearer ' + wx.getStorageSync('token')
    },
    success: (res: any) => {
      if (res.data.code === 200) {
        wx.showToast({ title: '评论成功', icon: 'success' })
        // ... 重置和刷新
      }
    }
  })
}
```

### 2. 提交回复API

```typescript
onReplySubmit(e: any) {
  const { videoId, content, parentId, replyToId } = e.detail
  
  // TODO: 替换为真实API调用
  wx.request({
    url: 'https://your-api.com/api/interaction/comment',
    method: 'POST',
    data: {
      videoId: videoId,
      content: content,
      parentId: parentId,      // 父评论ID
      replyToId: replyToId     // 回复目标用户ID
    },
    header: {
      'Authorization': 'Bearer ' + wx.getStorageSync('token')
    },
    success: (res: any) => {
      if (res.data.code === 200) {
        wx.showToast({ title: '回复成功', icon: 'success' })
        // ... 重置和刷新
      }
    }
  })
}
```

### 3. 添加登录检查

```typescript
showCommentInput() {
  // 检查登录状态
  const token = wx.getStorageSync('token')
  if (!token) {
    wx.showToast({
      title: '请先登录',
      icon: 'none'
    })
    // 跳转到登录页
    wx.navigateTo({
      url: '/pages/auth/login'
    })
    return
  }
  
  this.setData({ showCommentInput: true })
}
```

## 测试建议

1. ✅ 测试点击"发表评论"按钮是否弹出输入框
2. ✅ 测试输入评论内容和字数统计
3. ✅ 测试提交评论功能
4. ✅ 测试点击"回复"按钮是否弹出回复输入框
5. ✅ 测试回复输入框是否显示 @用户名
6. ✅ 测试提交回复功能
7. ✅ 测试点击遮罩关闭输入框
8. ✅ 测试点击取消按钮关闭输入框
9. ⏳ 测试登录状态检查（待添加）
10. ⏳ 测试真实API调用（待集成）

## 总结

✅ **已解决的问题：**
1. 添加了"发表评论"入口按钮
2. 点击"回复"按钮现在会弹出输入框（显示"回复 @用户名"）
3. 完整实现了评论和回复的输入、提交、取消功能

⏳ **待完成的工作：**
1. 集成真实的后端API
2. 添加登录状态检查
3. 添加错误处理和重试机制

现在用户可以正常发表评论和回复评论了！🎉
