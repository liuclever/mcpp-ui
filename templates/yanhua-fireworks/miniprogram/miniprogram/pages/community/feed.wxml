<!--pages/community/feed.wxml-->
<view class="feed-container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="nav-bar">
    <view class="back-btn" bindtap="goBack">
      <text class="back-icon">â†</text>
      <text class="back-text">è¿”å›</text>
    </view>
  </view>

  <!-- è§†é¢‘æ»‘åŠ¨å®¹å™¨ -->
  <swiper 
    class="video-swiper" 
    vertical="{{true}}"
    current="{{currentIndex}}"
    bindchange="onSwiperChange"
    circular="{{false}}"
    duration="{{300}}"
  >
    <swiper-item wx:for="{{videoList}}" wx:key="id" class="swiper-item">
      <view class="video-wrapper">
        <!-- è§†é¢‘æ’­æ”¾å™¨ -->
        <video
          id="video-player-{{index}}"
          class="video-player"
          src="{{item.videoUrl}}"
          poster="{{item.coverUrl}}"
          autoplay="{{currentIndex === index}}"
          loop="{{true}}"
          controls="{{true}}"
          show-center-play-btn="{{true}}"
          show-play-btn="{{true}}"
          enable-progress-gesture="{{false}}"
          object-fit="contain"
          bindplay="onVideoPlay"
          bindpause="onVideoPause"
          bindended="onVideoEnded"
          binderror="onVideoError"
        />
        
        <!-- ç‚¹å‡»åŒºåŸŸ - ç”¨äºæš‚åœ/æ’­æ”¾ï¼Œä½¿ç”¨bindtapä¸é˜»æ­¢æ»‘åŠ¨ -->
        <view class="video-tap-area" bindtap="onVideoTap" data-index="{{index}}"></view>

        <!-- è§†é¢‘ä¿¡æ¯å±‚ -->
        <view class="video-info">
          <!-- å‘å¸ƒè€…ä¿¡æ¯ -->
          <view class="author-info">
            <image class="avatar" src="{{item.userAvatar || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="author-details">
              <text class="nickname">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="time">{{item.createTime}}</text>
            </view>
          </view>

          <!-- è§†é¢‘æ ‡é¢˜å’Œæè¿° -->
          <view class="video-desc">
            <text class="title">{{item.title}}</text>
            <text class="description" wx:if="{{item.description}}">{{item.description}}</text>
            <view class="location" wx:if="{{item.location}}">
              <text class="location-icon">ğŸ“</text>
              <text class="location-text">{{item.location}}</text>
            </view>
          </view>
        </view>

        <!-- å³ä¾§äº’åŠ¨æ  -->
        <view class="interaction-side">
          <interaction-bar
            video-id="{{item.id}}"
            is-liked="{{item.isLiked}}"
            is-collected="{{item.isCollected}}"
            likes="{{item.likes}}"
            collects="{{item.collects}}"
            comments="{{item.comments}}"
            shares="{{item.shares}}"
            layout="vertical"
            bind:like="onLike"
            bind:collect="onCollect"
            bind:comment="onComment"
            bind:share="onShare"
          />
        </view>
      </view>
    </swiper-item>
  </swiper>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty" wx:if="{{!loading && videoList.length === 0}}">
    <image class="empty-icon" src="/assets/images/empty-video.png" mode="aspectFit" />
    <text class="empty-text">æš‚æ— è§†é¢‘</text>
  </view>

  <!-- åˆ†äº«é€‰æ‹©å¼¹çª— -->
  <view class="share-popup" wx:if="{{showSharePopup}}" catchtap="closeSharePopup">
    <view class="share-popup-content" catchtap="onPopupContentTap">
      <view class="share-popup-header">
        <text class="share-title">åˆ†äº«åˆ°</text>
        <view class="share-close" bindtap="closeSharePopup">
          <text>Ã—</text>
        </view>
      </view>
      <view class="share-options">
        <!-- åˆ†äº«ç»™å¾®ä¿¡å¥½å‹ -->
        <button class="share-option" open-type="share">
          <view class="share-icon wechat-icon">
            <text class="icon-text">å¾®ä¿¡</text>
          </view>
          <text class="share-label">å¾®ä¿¡å¥½å‹</text>
        </button>
        <!-- åˆ†äº«åˆ°æœ‹å‹åœˆ -->
        <view class="share-option" bindtap="shareToTimeline">
          <view class="share-icon timeline-icon">
            <text class="icon-text">åœˆ</text>
          </view>
          <text class="share-label">æœ‹å‹åœˆ</text>
        </view>
      </view>
      <view class="share-cancel" bindtap="closeSharePopup">
        <text>å–æ¶ˆ</text>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºå¼¹çª— -->
  <view class="comment-popup" wx:if="{{showCommentPopup}}" catchtap="closeCommentPopup">
    <view class="comment-popup-content" catchtap="onPopupContentTap">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="comment-popup-header">
        <view class="related-product">
          <text class="related-label">ç›¸å…³äº§å“ï¼š</text>
          <text class="product-name">ç¦ä¸´é—¨</text>
        </view>
        <view class="comment-popup-close" bindtap="closeCommentPopup">
          <image src="/assets/icons/close.png" mode="aspectFit" />
        </view>
      </view>
      
      <!-- è¯„è®ºæ•°é‡ -->
      <view class="comment-count">
        <text>{{videoList[currentIndex].comments || 0}}æ¡è¯„è®º</text>
      </view>
      
      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view class="comment-popup-body" catchtap="onPopupContentTap">
        <comment-list 
          video-id="{{currentVideoId}}"
          comments="{{comments}}"
          has-more="{{commentHasMore}}"
          loading="{{commentLoading}}"
          show-empty="{{!commentLoading && comments.length === 0}}"
          bind:reply="onCommentSuccess"
        />
      </view>
      
      <!-- è¯„è®ºè¾“å…¥æ¡† -->
      <view class="comment-popup-footer">
        <view class="comment-input-bar">
          <input 
            class="comment-input"
            type="text"
            placeholder="ç•™ä¸‹ä½ çš„è¯„è®ºå§"
            placeholder-class="comment-input-placeholder"
            value="{{commentInputValue}}"
            bindinput="onCommentInput"
            bindconfirm="onCommentSubmit"
            confirm-type="send"
          />
          <button 
            class="comment-send-btn {{commentInputValue ? 'active' : ''}}"
            bindtap="onCommentSubmit"
            disabled="{{!commentInputValue || commentSubmitting}}"
          >
            å‘é€
          </button>
        </view>
      </view>
    </view>
  </view>
</view>
